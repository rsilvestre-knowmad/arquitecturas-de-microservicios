# 5.1 ‚Äì API Gateway

---

## üéØ Objetivo

Comprender el rol del **API Gateway** dentro de una arquitectura de microservicios:
c√≥mo act√∫a como **punto de entrada √∫nico**, aplica pol√≠ticas de seguridad, balancea tr√°fico, unifica respuestas y reduce la complejidad del cliente.

---

## üß© Contexto

En una arquitectura de microservicios, cada servicio suele exponer su propia API:

* `orders-service` ‚Üí `/pedidos`
* `payments-service` ‚Üí `/pagos`
* `shipping-service` ‚Üí `/envios`

Esto obliga al cliente (frontend o app m√≥vil) a:

* conocer las URLs de todos los servicios,
* autenticarse varias veces,
* manejar formatos o pol√≠ticas distintas.

Para simplificar este escenario, introducimos un **API Gateway**.

---

## ‚öôÔ∏è ¬øQu√© es un API Gateway?

> Es un **punto √∫nico de entrada** que centraliza el acceso a todos los microservicios del sistema.

Su funci√≥n principal es **recibir las peticiones de los clientes, enrutar, agregar, autenticar o transformar** las solicitudes antes de entregarlas a los servicios internos.

---

## üß≠ Esquema general

```mermaid
graph LR
  A[Cliente / Frontend] -->|HTTP| G[API Gateway]
  G --> O[Orders Service]
  G --> P[Payments Service]
  G --> S[Shipping Service]
```

üëâ El cliente solo habla con **G (Gateway)**,
y este se encarga de comunicarse con los microservicios internos.

---

## üß± Funciones clave del API Gateway

| Categor√≠a                        | Funci√≥n                                      | Ejemplo                            |
| -------------------------------- | -------------------------------------------- | ---------------------------------- |
| **Ruteo**                        | Reenv√≠a las peticiones al servicio correcto. | `/api/pedidos ‚Üí orders-service`    |
| **Agregaci√≥n**                   | Combina datos de varios servicios.           | `/api/dashboard ‚Üí pedidos + pagos` |
| **Autenticaci√≥n / Autorizaci√≥n** | Valida tokens (JWT, OAuth2, API Keys).       | Header `Authorization`             |
| **Rate limiting**                | Controla el n√∫mero de peticiones.            | Evita abusos o DDoS                |
| **Cach√©**                        | Guarda respuestas recientes.                 | Respuestas GET                     |
| **Transformaci√≥n**               | Unifica formatos de respuesta.               | JSON normalizado                   |
| **Seguridad**                    | A√±ade HTTPS, CORS, validaciones.             | Configuraci√≥n centralizada         |

---

## üí° Ventajas

‚úÖ **Centraliza la seguridad y autenticaci√≥n.**
‚úÖ **Simplifica el acceso para los clientes.**
‚úÖ **Permite control de tr√°fico y pol√≠ticas.**
‚úÖ **A√≠sla los cambios internos de los servicios.**
‚úÖ **Mejora la trazabilidad y logging centralizado.**

---

## ‚ö†Ô∏è Desventajas

‚ö†Ô∏è Puede convertirse en un **punto √∫nico de fallo** si no se replica.
‚ö†Ô∏è A√±ade una **latencia adicional** en cada petici√≥n.
‚ö†Ô∏è Su configuraci√≥n y mantenimiento requieren cuidado.
‚ö†Ô∏è Debe dise√±arse para **no convertirse en un ‚Äúmonolito de red‚Äù**.

---

## üîê Patr√≥n com√∫n: Gateway + Authentication + Routing

```mermaid
flowchart LR
  C[Cliente] -->|JWT Token| G[API Gateway]
  G -->|Valida token| Auth[(Auth Service)]
  G -->|Rutea /pedidos| O[Orders Service]
  G -->|Rutea /pagos| P[Payments Service]
  G -->|Rutea /envios| S[Shipping Service]
```

---

## üß© Ejemplo funcional: Gateway con Express

A continuaci√≥n, un ejemplo b√°sico de API Gateway escrito en **Node.js + Express**.
Este gateway recibe peticiones y las reenv√≠a a servicios internos mediante `axios`.

### üìÑ `gateway.js`

```js
import express from "express";
import axios from "axios";

const app = express();
app.use(express.json());

// Configuraci√≥n de rutas hacia los microservicios
const ROUTES = {
  pedidos: "http://orders-service:3000",
  pagos: "http://payments-service:3001",
  envios: "http://shipping-service:3002"
};

// Middleware simple de logging
app.use((req, res, next) => {
  console.log(`‚û°Ô∏è  ${req.method} ${req.originalUrl}`);
  next();
});

// Middleware de autenticaci√≥n (ejemplo simplificado)
app.use((req, res, next) => {
  const token = req.headers.authorization;
  if (!token) return res.status(401).json({ error: "Falta token JWT" });
  // Aqu√≠ podr√≠amos validar el JWT contra un Auth Service
  next();
});

// Ruteo din√°mico hacia servicios internos
app.all("/api/:servicio/*", async (req, res) => {
  const { servicio } = req.params;
  const destino = ROUTES[servicio];
  if (!destino) return res.status(404).json({ error: "Servicio no encontrado" });

  const pathInterno = req.originalUrl.replace(`/api/${servicio}`, "");
  const url = `${destino}${pathInterno}`;

  try {
    const respuesta = await axios({
      method: req.method,
      url,
      data: req.body,
      headers: { Authorization: req.headers.authorization }
    });
    res.status(respuesta.status).json(respuesta.data);
  } catch (err) {
    console.error("‚ùå Error al reenviar petici√≥n:", err.message);
    res.status(500).json({ error: "Error interno del gateway" });
  }
});

app.listen(4000, () => console.log("üö™ API Gateway escuchando en puerto 4000"));
```

---

## üß™ Flujo de prueba conceptual

```bash
# 1. Cliente env√≠a token y crea pedido
curl -X POST http://localhost:4000/api/pedidos/crear \
  -H "Authorization: Bearer 1234" \
  -H "Content-Type: application/json" \
  -d '{"cliente":"Ana","total":120.5}'

# 2. Gateway valida el token y reenv√≠a al servicio interno:
# http://orders-service:3000/crear
```

---

## üìä Gateway dentro de una arquitectura distribuida

```mermaid
graph TD
  C[Cliente] -->|HTTP| G[API Gateway]
  G -->|/pedidos| O[Orders Service]
  G -->|/pagos| P[Payments Service]
  G -->|/envios| S[Shipping Service]
  G -->|/auth| A[Auth Service]
  G -->|/metrics| M[Monitoring / Prometheus]
```

üí° As√≠ el Gateway se convierte en el **front controller** de todos los servicios.

---

## üß† Patrones avanzados

| Patr√≥n                         | Descripci√≥n                                        | Ejemplo                        |
| ------------------------------ | -------------------------------------------------- | ------------------------------ |
| **BFF (Backend for Frontend)** | Un gateway especializado por cliente o canal.      | Uno para web, otro para m√≥vil. |
| **Edge Gateway**               | Gateway expuesto en la frontera p√∫blica de la red. | HTTPS / CDN / rate limit.      |
| **Service Mesh Gateway**       | Integrado en Istio / Linkerd, usa sidecars.        | Control de tr√°fico interno.    |

---

## üîê Integraci√≥n con autenticaci√≥n JWT

En el m√≥dulo **5.4 ‚Äì Laboratorio Gateway y JWT**,
implementaremos un **API Gateway real con autenticaci√≥n JWT**,
donde cada microservicio validar√° tokens firmados y el Gateway aplicar√° middleware de seguridad, control de acceso y logging centralizado.

---

## üîö Conclusi√≥n

El **API Gateway** es un componente esencial en las arquitecturas modernas:

* simplifica la comunicaci√≥n entre cliente y microservicios,
* centraliza seguridad y ruteo,
* facilita la observabilidad y la integraci√≥n con otros servicios (auth, logs, m√©tricas).

Es el punto ideal para **unificar control, autenticaci√≥n y resiliencia**,
pero debe dise√±arse con cuidado para no convertirse en un **cuello de botella**.